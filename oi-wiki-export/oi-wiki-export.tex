\documentclass[10pt,a4paper,openany]{book}
\usepackage[normalem]{ulem}
\usepackage[boldfont,slantfont,CJKmath=true]{xeCJK}
\usepackage{tocloft}
\usepackage{amsmath,amssymb,amsthm}
\usepackage[left=0.6in,right=0.6in,top=0.8in,bottom=0.8in]{geometry}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{enumitem}
\usepackage{parskip}
\usepackage{graphicx}
\usepackage[export]{adjustbox}
\usepackage{float}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{tabu}
\usepackage{longtable}
\usepackage[colorlinks,linkcolor=blue,urlcolor=blue,anchorcolor=blue,citecolor=blue,breaklinks=true,hyperfootnotes=true,unicode]{hyperref}
\usepackage{minted}
\usepackage{fvextra}
\usepackage{framed}
\usepackage{xcolor}
\usepackage{footnotebackref}
\usepackage{xpatch}
\usepackage{titlesec}
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{datetime}
\usepackage{caption}

% additional CJK characters for '←' and '→'
\xeCJKsetcharclass{"2190}{"2192}{1}% 1: CJK
\xeCJKsetup{xCJKecglue}

% date in Chinese
\renewcommand{\today}{\number\year 年 \number\month 月 \number\day 日}

\title{OI Wiki (Beta)}
\author{OI Wiki 项目组}
\date{\today}
\titleformat{\chapter}[display]{\Huge\bfseries}{第~\thechapter~章}{1em}{}

\setmainfont{CMU Serif}
\setsansfont{CMU Sans Serif}
\setmonofont[]{Roboto Mono}

\setCJKmainfont[ItalicFont={FandolKai}, BoldFont={FandolHei}]{FandolSong}
\setCJKmonofont{FandolHei}
\setCJKsansfont{FandolFang}
\setCJKsansfont{FandolHei}
\newCJKfontfamily\song{FandolSong}
\newCJKfontfamily\fangsong{FandolFang}
\newCJKfontfamily\kai{FandolKai}
\newCJKfontfamily\hei{FandolHei}

\pagestyle{fancy}

\renewcommand{\chaptername}{第~\thechapter~章}
\renewcommand{\chaptermark}[1]{\markboth{\chaptername\quad #1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\quad #1}}

% Original \paragraph and \subparagraph will change the indentation and spacing rule
% which is troublesome when succeeded by \begin{details}
% Replace them by naive implementations to avoid these issues

\def\paragraph*#1{\par\bigskip\noindent{\bfseries\large#1}\medskip}
\def\subparagraph*#1{\par\medskip\noindent{\sffamily#1}\smallskip}

\makeatletter
\renewcommand\section{\@startsection {section}{1}{\z@}%
                                   {-3.5ex \@plus -1ex \@minus -.2ex}%
                                   {2.3ex \@plus .2ex}%
                                   {\normalfont\huge\bfseries}}
\renewcommand\subsection{\@startsection {subsection}{2}{\z@}%
                                   {-3.25ex \@plus -1ex \@minus -.2ex}%
                                   {1.5ex \@plus .2ex}%
                                   {\normalfont\Large\bfseries}}
\renewcommand\subsubsection{\@startsection {subsubsection}{3}{\z@}%
                                   {-3.25ex \@plus -1ex \@minus -.2ex}%
                                   {1.5ex \@plus .2ex}%
                                   {\large\sffamily}}
\makeatother

\fancyhf{}
\fancyhead[LE,RO]{\thepage}
\fancyhead[RE]{\small\nouppercase\leftmark\rm}
\fancyhead[LO]{\small\it\nouppercase\rightmark\rm}

\setlength{\headheight}{12.5pt}

\setenumerate[1]{itemsep=0pt,partopsep=0pt,parsep=\parskip,topsep=5pt}
\setitemize[1]{itemsep=0pt,partopsep=0pt,parsep=\parskip,topsep=5pt}
\setdescription{itemsep=0pt,partopsep=0pt,parsep=\parskip,topsep=5pt}
\renewcommand{\figurename}{图}
\renewcommand{\tablename}{表}
\renewcommand{\contentsname}{目录}
\allowdisplaybreaks[4]

\definecolor{quote-color}{gray}{0.1}
\definecolor{quote-bg}{gray}{0.9}
\renewenvironment{quotation}{%
    \def\FrameCommand{
        {\color{quote-color}\vrule width 4pt}%
        \color{quote-color}%
        \colorbox{quote-bg}
    }
    \OuterFrameSep=2pt
    \MakeFramed{\advance\hsize-\width\FrameRestore}
    \vskip.3em minus .3em\nobreak
    \leftskip=1em
    \rightskip=1em \CJKfamily+{FandolKai}
}{%
    \par\nobreak\vskip.3em minus .3em
    \endMakeFramed
}

\definecolor{warning-orange}{RGB}{255, 145, 0}
\definecolor{info-blue}{RGB}{68, 138, 255}
\definecolor{Red}{rgb}{1,0,0}
\definecolor{Blue}{rgb}{0,0,1}

\newenvironment{details}[2]{%
    \vskip.5em 
    \begin{mdframed}[%
        roundcorner=3pt,
        linewidth=0pt,
        backgroundcolor=#1!20!white,
        frametitle={\vskip-0.5em\parindent=0pt#2},
        frametitlefont={\sffamily},
        frametitlerule=false,
        frametitlebackgroundcolor=#1!50!white,
    ]%
    \def\isInDetail{}
}{%
    \end{mdframed}
}

\captionsetup[figure]{labelsep=space}
\captionsetup[table]{labelsep=space}

% framed settings
\definecolor{shadecolor}{rgb}{0.95, 0.95, 0.96}

\newcommand{\hyref}[2]{\href{#1}{\hyphenchar\font="200B #2}}

% auto-wrap typewriter style
\newcommand{\hytt}[1]{\texttt{\hyphenchar\font="200B #1}}

% minted settings
\setminted{fontsize=\small}
\newmdenv[%
    roundcorner=3pt,
    linewidth=0pt,
    backgroundcolor=black!5!white,
    frametitle={},
]{mintedWrap}
\BeforeBeginEnvironment{minted}{%
    \ifdefined\isInDetail \else 
        \medskip\begin{mintedWrap}
    \fi
}
\AfterEndEnvironment{minted}{%
    \ifdefined\isInDetail \else 
        \end{mintedWrap}\medskip
    \fi
}

% customize TOC
\cftsetpnumwidth{2em}
\cftsetindents{chapter}{0em}{2em}
\cftsetindents{section}{2em}{3em}
\cftsetindents{subsection}{5em}{4em}

% image related
\graphicspath{{images/}}
\makeatletter
\def\maxwidth#1{\ifdim\Gin@nat@width>#1 #1\else\Gin@nat@width\fi}
\makeatother

% URL auto line break
\makeatletter
\def\UrlAlphabet{%
	\do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j%
	\do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t%
	\do\u\do\v\do\w\do\x\do\y\do\z\do\A\do\B\do\C\do\D%
	\do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M\do\N%
	\do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X%
	\do\Y\do\Z%
}
\def\UrlDigits{\do\1\do\2\do\3\do\4\do\5\do\6\do\7\do\8\do\9\do\0}
\g@addto@macro{\UrlBreaks}{\UrlOrds}
\g@addto@macro{\UrlBreaks}{\UrlAlphabet}
\g@addto@macro{\UrlBreaks}{\UrlDigits}
\makeatother

% blockquote 2em indent
\patchcmd{\quotation}{1.5em}{2em}{}{}

% metric adjustment
\renewcommand{\baselinestretch}{1.2}\normalsize % 行距设置
\setlength{\parskip}{.2\baselineskip}
\renewcommand{\headrulewidth}{0mm} % 页眉横线宽度
\setlength{\parindent}{2em} % 中文缩进两个汉字位
\setlength{\tabcolsep}{2pt} % 表格列间距 2pt

% do not indent the first paragraph
\makeatletter \let\@afterindentfalse\@afterindenttrue \@afterindenttrue \makeatother

\begin{document}
	\maketitle
	\frontmatter
	\tableofcontents
	\clearpage
	\mainmatter
	\input{includes}
\end{document}
